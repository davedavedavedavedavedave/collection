import { Injectable } from '@angular/core';
import { Observable, from, of, ReplaySubject } from 'rxjs';
import { fromFetch } from 'rxjs/fetch';
import { map, mergeMap, catchError, tap, take } from 'rxjs/operators';
import { Card } from './card';

const BASE_URL = 'https://ccgdb.uber.space/user/profile_edit';
const DATA_URL = 'https://ccgdb.uber.space/collection/app.php';
const DUMMY_HTML: string = '<!DOCTYPE html><html lang="en"><head><title>A Game of Thrones Deckbuilder &middot; ThronesDB</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="robots" content="noindex"><meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="192x192" href="/icon-192.png"/><link rel="apple-touch-icon" sizes="120x120" href="/icon-120.png"/><meta name="description" content="Build your deck for A Game of Thrones by Fantasy Flight Games. Browse the cards and the thousand of decklists submitted by the community. Publish your own decks and get feedback."><link href=\'https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,700,700i|Julius+Sans+One|Open+Sans:400,400i,700,700i|Open+Sans+Condensed:300\'rel=\'stylesheet\' type=\'text/css\'><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/2.1.1/jquery.qtip.css"><link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-markdown/2.9.0/css/bootstrap-markdown.min.css"><link rel="stylesheet" type="text/css"href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"/><link rel="stylesheet" href="/css/app.css"/><!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js"></script><![endif]--><script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script><script>window.addEventListener("load", function () {window.cookieconsent.initialise({"palette": {"popup": {"background": "#000"},"button": {"background": "#f1d600"}}})});</script></head><body><div id="wrapper"><nav class="navbar navbar-default navbar-static-top" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><span class="icon icon-link-half-top"></span><span class="icon icon-link-half-bottom"></span><span class="icon icon-power"></span> ThronesDB</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href="/decks">My decks</a></li><li><a href="/decklists">Decklists</a></li><li><a href="/search">Cards</a></li><li class="hidden-sm"><a href="/reviews">Reviews</a></li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"aria-expanded="false">Rules <span class="caret"></span></a><ul class="dropdown-menu" role="menu"><li><a href="/bundles/app/images/rulesreference/LegacyFAQ7_1.pdf">F.A.Q.</a></li></ul></li></ul><ul class="nav navbar-nav navbar-right"><li class="dropdown hidden-xs hidden-lg"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"aria-expanded="false"><span class="fas fa-search"></span></a><div class="dropdown-menu"><form action="/find"><input type="text" placeholder="Card Search"class="form-control smart-filter-help" name="q"></form></div></li><li id="login"><a href="#" class="disabled"><span class="fas fa-user"></span></a></li></ul><form class="navbar-form navbar-right visible-lg-block visible-xs-block external"action="/find"><div class="form-group"><input type="text" placeholder="Card Search"class="form-control smart-filter-help" name="q"></div></form></div><!--/.navbar-collapse --></div></nav><div class="main container"><h1 class="site-title hidden-xs">Thr<span style="position:relative">o<span class="icon icon-power"style="position:absolute;left: .65em;top: 1.2em;font-size: 30%;"></span></span>nesDB</h1><div class="site-slogan">Deckbuilder for A Game of Thrones CCG</div></div> <!-- .container --><div class="main container"><div class="row"><div class="col-md-6" style="margin-bottom:30px"><div class="bg-faction bg-baratheon" style="padding:10px 10px 5px 10px"><div class="media"><div class="media-left" style="font-size:30px"><span class="icon icon-baratheon"></span></div><div class="media-body"><h4 class="media-heading" style="white-space:nowrap"><ahref="/decklist/view/9/2018-09-05-munich-draft-second-place-1.0">2018-09-05 Munich Draft - Second Place</a></h4><div class="small">by                                         <span class="username">    <a href="/user/profile/1/dave"class="username">dave</a><small title="User Reputation">1</small></span>&middot;<time datetime="2020-09-06T15:14:42+02:00">Sep 06, 2020</time></div></div></div></div><div style="background-color: white; padding: 10px 20px 20px 20px"><div class="small pull-right"><span class="social-icons"><span class="social-icon-like" data-toggle="tooltip" data-placement="bottom"title="Like"><span class="fas fa-heart"></span> <span class="num">0</span></span><span class="social-icon-favorite" data-toggle="tooltip" data-placement="bottom"title="Favorite"><span class="fas fa-star"></span> <span class="num">0</span></span><span class="social-icon-comment" data-toggle="tooltip"data-placement="bottom" title="Comment"><span class="fas fa-comment"></span> <span class="num">1</span></span><span class="social-icon-version" data-toggle="tooltip" data-placement="bottom"title="Version"><span class="fas fa-code-branch"></span> <span class="num">1.0</span></span></span></div><div>House Baratheon</div><p>19 Characters &bull; 11 Locations &bull; 5 Attachments &bull; 5 Events</p><div class="text-center small"><ahref="/decklists/find?faction=baratheon">More in this faction</a></div><div style="clear:both"></div></div></div><div class="col-md-6" style="margin-bottom:30px"><div class="bg-faction bg-greyjoy" style="padding:10px 10px 5px 10px"><div class="media"><div class="media-left" style="font-size:30px"><span class="icon icon-greyjoy"></span></div><div class="media-body"><h4 class="media-heading" style="white-space:nowrap"><ahref="/decklist/view/1/2020-01-18-munich-draft-winner-1.0">2020-01-18 Munich Draft - Winner</a></h4><div class="small">by                                         <span class="username">    <a href="/user/profile/1/dave"class="username">dave</a><small title="User Reputation">1</small></span>&middot;<time datetime="2020-01-26T20:48:28+01:00">Jan 26, 2020</time></div></div></div></div><div style="background-color: white; padding: 10px 20px 20px 20px"><div class="small pull-right"><span class="social-icons"><span class="social-icon-like" data-toggle="tooltip" data-placement="bottom"title="Like"><span class="fas fa-heart"></span> <span class="num">0</span></span><span class="social-icon-favorite" data-toggle="tooltip" data-placement="bottom"title="Favorite"><span class="fas fa-star"></span> <span class="num">0</span></span><span class="social-icon-comment" data-toggle="tooltip"data-placement="bottom" title="Comment"><span class="fas fa-comment"></span> <span class="num">2</span></span><span class="social-icon-version" data-toggle="tooltip" data-placement="bottom"title="Version"><span class="fas fa-code-branch"></span> <span class="num">1.0</span></span></span></div><div>House Greyjoy / The Nightswatch</div><p>20 Characters &bull; 11 Locations &bull; 2 Attachments &bull; 7 Events</p><div class="text-center small"><ahref="/decklists/find?faction=greyjoy">More in this faction</a></div><div style="clear:both"></div></div></div><div class="col-md-6" style="margin-bottom:30px"><div class="bg-faction bg-lannister" style="padding:10px 10px 5px 10px"><div class="media"><div class="media-left" style="font-size:30px"><span class="icon icon-lannister"></span></div><div class="media-body"><h4 class="media-heading" style="white-space:nowrap"><ahref="/decklist/view/7/top4-2019-dec-budapest-draft-house-tyrell-1.0">TOP4 2019 DEC Budapest Draft:  House Tyrell </a></h4><div class="small">by                                         <span class="username">    <a href="/user/profile/5/LordHumungus"class="username">LordHumungus</a><small title="User Reputation">2</small></span>&middot;<time datetime="2020-02-24T10:10:30+01:00">Feb 24, 2020</time></div></div></div></div><div style="background-color: white; padding: 10px 20px 20px 20px"><div class="small pull-right"><span class="social-icons"><span class="social-icon-like" data-toggle="tooltip" data-placement="bottom"title="Like"><span class="fas fa-heart"></span> <span class="num">1</span></span><span class="social-icon-favorite" data-toggle="tooltip" data-placement="bottom"title="Favorite"><span class="fas fa-star"></span> <span class="num">0</span></span><span class="social-icon-comment" data-toggle="tooltip"data-placement="bottom" title="Comment"><span class="fas fa-comment"></span> <span class="num">3</span></span><span class="social-icon-version" data-toggle="tooltip" data-placement="bottom"title="Version"><span class="fas fa-code-branch"></span> <span class="num">1.0</span></span></span></div><div>House Lannister</div><p>22 Characters &bull; 11 Locations &bull; 2 Attachments &bull; 5 Events</p><div class="text-center small"><ahref="/decklists/find?faction=lannister">More in this faction</a></div><div style="clear:both"></div></div></div><div class="col-md-6" style="margin-bottom:30px"><div class="bg-faction bg-martell" style="padding:10px 10px 5px 10px"><div class="media"><div class="media-left" style="font-size:30px"><span class="icon icon-martell"></span></div><div class="media-body"><h4 class="media-heading" style="white-space:nowrap"><ahref="/decklist/view/8/2020-07-25-munich-draft-winner-1.0">2020-07-25 Munich Draft - Winner</a></h4><div class="small">by                                         <span class="username">    <a href="/user/profile/1/dave"class="username">dave</a><small title="User Reputation">1</small></span>&middot;<time datetime="2020-07-26T15:55:12+02:00">Jul 26, 2020</time></div></div></div></div><div style="background-color: white; padding: 10px 20px 20px 20px"><div class="small pull-right"><span class="social-icons"><span class="social-icon-like" data-toggle="tooltip" data-placement="bottom"title="Like"><span class="fas fa-heart"></span> <span class="num">0</span></span><span class="social-icon-favorite" data-toggle="tooltip" data-placement="bottom"title="Favorite"><span class="fas fa-star"></span> <span class="num">0</span></span><span class="social-icon-comment" data-toggle="tooltip"data-placement="bottom" title="Comment"><span class="fas fa-comment"></span> <span class="num">1</span></span><span class="social-icon-version" data-toggle="tooltip" data-placement="bottom"title="Version"><span class="fas fa-code-branch"></span> <span class="num">1.0</span></span></span></div><div>House Martell</div><p>19 Characters &bull; 15 Locations &bull; 3 Attachments &bull; 3 Events</p><div class="text-center small"><ahref="/decklists/find?faction=martell">More in this faction</a></div><div style="clear:both"></div></div></div><div class="col-md-6" style="margin-bottom:30px"><div class="bg-faction bg-targaryen" style="padding:10px 10px 5px 10px"><div class="media"><div class="media-left" style="font-size:30px"><span class="icon icon-targaryen"></span></div><div class="media-body"><h4 class="media-heading" style="white-space:nowrap"><ahref="/decklist/view/5/2020-02-16-munich-draft-fourth-place-1.0">2020-02-16 Munich Draft - Fourth Place</a></h4><div class="small">by                                         <span class="username">    <a href="/user/profile/1/dave"class="username">dave</a><small title="User Reputation">1</small></span>&middot;<time datetime="2020-02-17T17:32:39+01:00">Feb 17, 2020</time></div></div></div></div><div style="background-color: white; padding: 10px 20px 20px 20px"><div class="small pull-right"><span class="social-icons"><span class="social-icon-like" data-toggle="tooltip" data-placement="bottom"title="Like"><span class="fas fa-heart"></span> <span class="num">0</span></span><span class="social-icon-favorite" data-toggle="tooltip" data-placement="bottom"title="Favorite"><span class="fas fa-star"></span> <span class="num">0</span></span><span class="social-icon-comment" data-toggle="tooltip"data-placement="bottom" title="Comment"><span class="fas fa-comment"></span> <span class="num">5</span></span><span class="social-icon-version" data-toggle="tooltip" data-placement="bottom"title="Version"><span class="fas fa-code-branch"></span> <span class="num">1.0</span></span></span></div><div>House Targaryen</div><p>21 Characters &bull; 9 Locations &bull; 7 Attachments &bull; 3 Events</p><div class="text-center small"><ahref="/decklists/find?faction=targaryen">More in this faction</a></div><div style="clear:both"></div></div></div></div></div><div id="push"></div></div><footer class="hidden-print"><div class="container"><div class="row" style="margin-bottom:2em"><div class="col-xs-12"><ul class="list-inline"><li><a href="/about">About</a></li><li><a href="/api/">API</a></li><li><a href="/donators">Donators</a><span class="fas fa-gift donator" title="The Gracious Donator"></span></li><li><a href="javascript:localStorage.clear()">Clear data</a></li></ul></div><div class="col-md-8"><p>Designed and built by <a href="https://github.com/alsciende">Alsciende</a>.</p><p>Maintained by <a href="https://github.com/stopfstedt">stopfstedt</a>Contact:<a href="https://twitter.com/ThronesDB" title="Twitter"><span class="fab fa-twitter"></span></a><a href="mailto:webmaester@thronesdb.com" title="E-mail"><span class="fas fa-envelope"></span></a></p><p>Cards data maintained with great dedication by the <ahref="https://github.com/throneteki">TheIronThrone.net</a> team.</p><p>Please post bug reports and feature requests on <a href="https://github.com/ThronesDB/thronesdb/issues">GitHub</a>.</p><p>You may contribute by giving money on <a href="https://paypal.me/stopfstedt">Paypal</a>.</p></div><div class="col-md-4"><p>The information presented on this site about A Game of Thrones: The Card Game Second Edition, both literaland graphical, is copyrighted by Fantasy Flight Games.This website is not produced, endorsed, supported, or affiliated with Fantasy Flight Games.</p></div></div></div></footer><!--  card modal --><div class="modal" id="cardModal" tabindex="-1" role="dialog" aria-labelledby="cardModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h3 class="modal-title card-name">Modal title</h3><div class="row"><div class="col-sm-12 text-center"><div class="btn-group modal-qty" data-toggle="buttons"></div></div></div></div><div class="modal-body"><div class="row"><div class="col-sm-6 modal-image hidden-xs"></div><div class="col-sm-6 modal-info card-content"></div></div></div><div class="modal-footer"><a role="button" href="#"class="btn btn-default card-modal-link">Go to card page</a><button type="button" class="btn btn-primary" data-dismiss="modal">Close</button></div></div></div></div><!--  /cardModal --><script src="/bundles/fosjsrouting/js/router.js"></script><script src="/js/routing?callback=fos.Router.setData"></script><script src="/js/89bbfb3.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/forerunnerdb/1.4.40/fdb-all.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/2.1.1/jquery.qtip.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.4/typeahead.jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.textcomplete/0.2.2/jquery.textcomplete.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment-with-locales.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/4.1.7/highcharts.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-markdown/2.9.0/js/bootstrap-markdown.min.js"></script><script src="/js/465c6d4.js"></script><script type="text/javascript">var app = {};moment.locale(\'en\');$(function () {});</script><script>(function (i, s, o, g, r, a, m) {i[\'GoogleAnalyticsObject\'] = r;i[r] = i[r] || function () {(i[r].q = i[r].q || []).push(arguments)}, i[r].l = 1 * new Date();a = s.createElement(o),m = s.getElementsByTagName(o)[0];a.async = 1;a.src = g;m.parentNode.insertBefore(a, m)})(window, document, \'script\', \'//www.google-analytics.com/analytics.js\', \'ga\');ga(\'create\', \'UA-00000000-1\', \'auto\');ga(\'send\', \'pageview\');</script><script src="/js/app.js"></script><script type="application/ld+json">{"@context": "http://schema.org","@type": "WebSite","url": "https://thronesdb.com/","potentialAction": {"@type": "SearchAction","target": "http://thronesdb.com/find/?q={search_term_string}","query-input": "required name=search_term_string"}}</script></body></html>';

@Injectable({
  providedIn: 'root'
})
export class CrawlerService {
  private _html$: Observable<string>;

  constructor() {
    this._html$ = fromFetch(BASE_URL).pipe(
      mergeMap(resp => from(resp.text())),
      catchError(err => of(DUMMY_HTML))
    );
  }

  getHeaderHtml(): Observable<string> {
    return this._html$.pipe(
      map(text => text.match(/<nav.*<\/nav>/gms)[0]),
    );
  }
  getFooterHtml(): Observable<string> {
    return this._html$.pipe(
      map(text => text.match(/<footer.*<\/footer>/gms)[0]),
    );
  }
  getCollectionFor(name: string): Observable<Card[]> {
    return fromFetch(DATA_URL).pipe(
      mergeMap(resp => from(resp.json())),
      map(json => json.map(r => Card.buildFromObject(r)))
    )
  }
  getUserName(): Observable<string> {
    return this._html$.pipe(
      map(text => text.match(/<input type="text" name="username" id="username" value="(.*?)"/gsm)[1])
    )
  }
  getCollection(): Observable<Card[]> {
    return this.getUserName().pipe(
      mergeMap(name => this.getCollectionFor(name))
    )
  }
}
